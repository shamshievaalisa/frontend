// modules/ordersView.js

(function () {
  const API_BASE = "http://localhost:8081";
  const API_URL_ORDERS = API_BASE + "/orders";
  const API_URL_CLIENTS = API_BASE + "/clients";
  const API_URL_CURRENT_USER = API_BASE + "/users/me"; // ‚Üê –ù–û–í–û–ï
  const API_URL_PRODUCTS = API_BASE + "/products";

  let allOrders = [];
  let allClients = [];
  let allProducts = [];
  let allEmployees = [];
  let currentUser = null;
  let currentEmployeeId = null; // ‚Üê ID —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
  let currentOrderId = null;
  let orderTempItems = []; // –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü–∏–π –≤ –º–æ–¥–∞–ª–∫–µ

  function getToken() {
    return localStorage.getItem("jwt");
  }

  const formatDate = (dateStr) => (dateStr ? dateStr.split("T")[0] : "");

  // === –ó–ê–ì–†–£–ó–ö–ê –¢–ï–ö–£–©–ï–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ===
  async function loadCurrentUser() {
    const token = getToken();
    if (!token) {
      // –ï—Å–ª–∏ JWT –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ø–æ–ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ currentUser (mock login)
      if (window.currentUser) {
        currentUser = window.currentUser;
        currentEmployeeId = currentUser.id;
        console.warn('JWT –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º window.currentUser –∫–∞–∫ fallback', currentUser);
        return currentUser;
      }

      console.error("–¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ localStorage");
      alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.");
      return null;
    }

    try {
      const response = await fetch(API_URL_CURRENT_USER, {
        headers: { Authorization: "Bearer " + token },
      });

      if (!response.ok) {
        const text = await response.text().catch(() => "");
        console.error("–û—à–∏–±–∫–∞ /users/me:", response.status, text);
        // –ü—Ä–∏ 401 –æ—á–∏—Å—Ç–∏–º —Ç–æ–∫–µ–Ω –∏ –Ω–∞–ø—Ä–∞–≤–∏–º –Ω–∞ –ª–æ–≥–∏–Ω
        if (response.status === 401) {
          try {
            localStorage.removeItem('jwt');
          } catch (e) {}
          alert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ.");
          if (typeof window.showView === 'function') window.showView('login');
          return null;
        }
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
        return null;
      }

      const user = await response.json();
      if (user.id == null) {
        console.error("–í –æ—Ç–≤–µ—Ç–µ –Ω–µ—Ç id:", user);
        alert("–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
        return null;
      }

      currentEmployeeId = user.id;
      currentUser = user;
      console.log(
        "–¢–µ–∫—É—â–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –∑–∞–≥—Ä—É–∂–µ–Ω:",
        user.fullName,
        "(ID:",
        user.id,
        ")"
      );
      return user;
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", e);
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞");
      return null;
    }
  }


  async function loadReferenceData() {
    const token = getToken();
    const headers = { Authorization: "Bearer " + token };

    try {
      const [clientsRes, productsRes] = await Promise.all([
        fetch(API_URL_CLIENTS, { headers }),
        fetch(API_URL_PRODUCTS, { headers }),
      ]);

      if (!clientsRes.ok || !productsRes.ok) {
        throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤");
      }

      allClients = await clientsRes.json();
      allProducts = await productsRes.json();

      renderClientsSelect();
      renderProductSelect();
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤:", e);
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–ª–∏ —Ç–æ–≤–∞—Ä—ã");
    }
  }


  function renderClientsSelect() {
    const select = document.getElementById("orderClientId");
    if (!select) return;

    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option>';
    allClients.forEach((client) => {
      const option = document.createElement("option");
      option.value = client.id;
      option.textContent =
        client.fullName || client.name || `–ö–ª–∏–µ–Ω—Ç ${client.id}`;
      select.appendChild(option);
    });
  }

  function renderProductSelect() {
    const select = document.getElementById("orderProductSelect");
    if (!select) return;

    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>';
    allProducts.forEach((p) => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = `${p.name} ‚Äî ${p.price} ‚ÇΩ`;
      opt.dataset.price = p.price;
      select.appendChild(opt);
    });
  }


async function loadOrders() {
  const tbody = document.getElementById("ordersTableBody");
  if (!tbody) return;

  const showRow = (html) => {
    tbody.innerHTML = `<tr><td colspan="5" class="text-center">${html}</td></tr>`;
  };

  showRow("–ó–∞–≥—Ä—É–∑–∫–∞...");

  const token = getToken();
  if (!token) {
    console.error("‚ùå –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–∫–∞–∑–æ–≤");
    showRow('<span class="text-danger">–ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</span>');
    return;
  }

  // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ currentUser/currentEmployeeId –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
  if (!currentUser || !currentEmployeeId) {
    await loadCurrentUser();
  }

  const headers = { Authorization: "Bearer " + token };

  // –†–æ–ª—å –±–µ—Ä—ë–º –∏–∑ currentUser, –∞ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç ‚Äî –∏–∑ JWT
  const parseJwt = (t) => {
    try {
      const payload = t.split(".")[1];
      const json = atob(payload.replace(/-/g, "+").replace(/_/g, "/"));
      return JSON.parse(decodeURIComponent(escape(json)));
    } catch {
      return null;
    }
  };

  const getEffectiveRole = () => {
    let role = currentUser && currentUser.role ? String(currentUser.role) : null;
    if (!role) {
      const p = parseJwt(token);
      role = p?.role || p?.roles || p?.authorities || null;
      if (Array.isArray(role)) role = role[0];
    }
    role = role ? String(role) : "";
    if (role.startsWith("ROLE_")) role = role.slice(5);
    return role.toUpperCase();
  };

  const role = getEffectiveRole();
  const isManager = role === "MANAGER";

  const ordersUrl =
    isManager && currentEmployeeId != null
      ? `${API_URL_ORDERS}?employeeId=${encodeURIComponent(currentEmployeeId)}`
      : API_URL_ORDERS;

  try {
    console.log("üì° –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º:", {
      ordersUrl,
      clients: API_URL_CLIENTS,
      employees: isManager ? "skipped" : `${API_BASE}/users`,
      role,
      currentEmployeeId,
    });

    // orders + clients –≤—Å–µ–≥–¥–∞ –Ω—É–∂–Ω—ã, employees ‚Äî —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É
    const [ordersRes, clientsRes, employeesRes] = await Promise.all([
      fetch(ordersUrl, { headers }),
      fetch(API_URL_CLIENTS, { headers }),
      isManager ? Promise.resolve(null) : fetch(`${API_BASE}/users`, { headers }),
    ]);

    console.log("üìä –°—Ç–∞—Ç—É—Å—ã –æ—Ç–≤–µ—Ç–æ–≤:", {
      orders: ordersRes.status,
      clients: clientsRes.status,
      employees: employeesRes ? employeesRes.status : "skipped",
    });

  
    const handleAuthFail = async (res) => {
      if (res.status === 401) {
        try { localStorage.removeItem("jwt"); } catch (e) {}
        alert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.");
        if (typeof window.showView === "function") window.showView("login");
        return true;
      }
      return false;
    };

    if (await handleAuthFail(ordersRes)) return;
    if (await handleAuthFail(clientsRes)) return;

    // –ö—Ä–∏—Ç–∏—á–Ω–æ: orders + clients
    if (!ordersRes.ok) {
      const text = await ordersRes.text().catch(() => "");
      console.error("‚ùå –û—à–∏–±–∫–∞ /orders:", ordersRes.status, text);
      showRow('<span class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</span>');
      return;
    }
    if (!clientsRes.ok) {
      const text = await clientsRes.text().catch(() => "");
      console.error("‚ùå –û—à–∏–±–∫–∞ /clients:", clientsRes.status, text);
      showRow('<span class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</span>');
      return;
    }

    // –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ: employees (–¥–ª—è MANAGER –ø—Ä–æ–ø—É—Å–∫–∞–µ–º, –¥–ª—è ADMIN –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å ‚Äî –Ω–µ –≤–∞–ª–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É)
    if (employeesRes && !employeesRes.ok) {
      const text = await employeesRes.text().catch(() => "");
      console.warn("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å /users:", employeesRes.status, text);
    }

    allOrders = await ordersRes.json();
    allClients = await clientsRes.json();

    if (isManager) {
      // —á—Ç–æ–±—ã –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–µ –±—ã–ª–æ "‚Äî" –∏ –Ω–µ –Ω—É–∂–µ–Ω /users
      allEmployees = currentUser ? [currentUser] : [];
    } else {
      allEmployees = employeesRes && employeesRes.ok ? await employeesRes.json() : [];
    }

    console.log("‚úÖ –ó–∞–∫–∞–∑—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", allOrders.length);
    displayOrders(allOrders);
  } catch (e) {
    console.error("üí• –û—à–∏–±–∫–∞ –≤ loadOrders:", e);
    showRow('<span class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</span>');
  }
}

  function getClientNameById(id) {
    const c = allClients.find((x) => x.id === id);
    return c ? c.fullName || c.name || "‚Äî" : "‚Äî";
  }

function getEmployeeNameById(id) {
  // null/undefined/"" -> –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
  if (id == null || id === "") return "‚Äî";

  const empId = Number(id);

  // 1) –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –∏–º—è –¥–∞–∂–µ –±–µ–∑ /users
  if (currentUser && currentEmployeeId != null && empId === Number(currentEmployeeId)) {
    return (
      currentUser.fullName ||
      currentUser.login ||
      currentUser.username ||
      `–°–æ—Ç—Ä—É–¥–Ω–∏–∫ ${empId}`
    );
  }

  // 2) –ò—â–µ–º –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (—Ç–æ–ª—å–∫–æ —É ADMIN –∏–ª–∏ –µ—Å–ª–∏ –≤—ã –µ–≥–æ –Ω–∞–ø–æ–ª–Ω—è–µ—Ç–µ)
  if (Array.isArray(allEmployees) && allEmployees.length > 0) {
    const user = allEmployees.find((u) => Number(u.id) === empId);
    if (user) {
      return user.fullName || user.login || user.username || `–°–æ—Ç—Ä—É–¥–Ω–∏–∫ ${empId}`;
    }
  }

  // 3) –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ
  return `–°–æ—Ç—Ä—É–¥–Ω–∏–∫ ${empId}`;
}

  function getProductNameById(id) {
    const p = allProducts.find((x) => x.id === id);
    return p ? p.name : "‚Äî";
  }

  function displayOrders(orders) {
    const tbody = document.getElementById("ordersTableBody");
    if (!tbody) return;

    if (!orders || orders.length === 0) {
      tbody.innerHTML =
        '<tr><td colspan="5" class="text-center">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
      return;
    }

    tbody.innerHTML = orders
      .map(
        (o) => `
        <tr>
            <td>${o.id || ""}</td>
            <td>${formatDate(o.date) || "‚Äî"}</td>
            <td>${getClientNameById(o.clientId) || "‚Äî"}</td>
            <td>${getEmployeeNameById(o.employeeId) || "‚Äî"}</td>
            <td>
                <button class="btn btn-sm btn-info me-1" onclick="viewOrderItems(${
                  o.id
                })">–ü–æ–∑–∏—Ü–∏–∏</button>
                <button class="btn btn-sm btn-danger" onclick="deleteOrder(${
                  o.id
                })">–£–¥–∞–ª–∏—Ç—å</button>
            </td>
        </tr>
    `
      )
      .join("");
  }

  // === –ü–û–ò–°–ö ===
  function filterOrders() {
    const term =
      document.getElementById("searchOrders")?.value?.toLowerCase() || "";
    const filtered = allOrders.filter(
      (o) =>
        String(o.id).includes(term) ||
        formatDate(o.date).includes(term) ||
        getClientNameById(o.clientId).toLowerCase().includes(term) ||
        (o.employeeName || "").toLowerCase().includes(term)
    );
    displayOrders(filtered);
  }

function calculateOrderTotal() {
  let total = 0;
  for (const item of orderTempItems) {
    total += item.quantity * item.priceAtMoment;
  }
  document.getElementById("orderTotal").textContent = total.toFixed(2);
}

async function loadOrderItems(orderId) {
    const tbody = document.getElementById("orderItemsTableBody");
    if (!tbody) return;

    tbody.innerHTML = '<tr><td colspan="6" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

    const token = getToken();
    const headers = { "Authorization": "Bearer " + token };

    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ü–û–ó–ò–¶–ò–ò –∏ –¢–û–í–ê–†–´ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
        const [itemsRes, productsRes] = await Promise.all([
            fetch(`${API_BASE}/order-items?orderId=${orderId}`, { headers }),
            fetch(API_URL_PRODUCTS, { headers })
        ]);

        if (!itemsRes.ok || !productsRes.ok) {
            throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
        }

        const items = await itemsRes.json();
        allProducts = await productsRes.json(); // ‚Üê —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤

        displayOrderItems(items, orderId);
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∑–∏—Ü–∏–π:", e);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">–û—à–∏–±–∫–∞</td></tr>';
    }
}
  function displayOrderItems(items, orderId) {
    const tbody = document.getElementById("orderItemsTableBody");
    if (!tbody) return;

    if (!items || items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">–ü–æ–∑–∏—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</td></tr>';
        return;
    }

    tbody.innerHTML = items.map(item => `
        <tr>
            <td>${item.id}</td>
            <td>${getProductNameById(item.productId)}</td>
            <td>${item.quantity}</td>
            <td>${item.priceAtMoment} ‚ÇΩ</td>
            <td>${(item.quantity * item.priceAtMoment).toFixed(2)} ‚ÇΩ</td>
            <td>
                <select class="form-select form-select-sm status-select" 
                        data-item-id="${item.id}" 
                        onchange="updateOrderItemStatus(${item.id}, this.value)">
                    <option value="NEW" ${item.status === 'NEW' ? 'selected' : ''}>–ù–æ–≤—ã–π</option>
                    <option value="IN_PROGRESS" ${item.status === 'IN_PROGRESS' ? 'selected' : ''}>–í —Ä–∞–±–æ—Ç–µ</option>
                    <option value="DONE" ${item.status === 'DONE' ? 'selected' : ''}>–í—ã–ø–æ–ª–Ω–µ–Ω</option>
                    <option value="CANCELED" ${item.status === 'CANCELED' ? 'selected' : ''}>–û—Ç–∫–∞–∑</option>
                </select>
            </td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="deleteOrderItem(${orderId}, ${item.id})">–£–¥–∞–ª–∏—Ç—å</button>
            </td>
        </tr>
    `).join("");
}

window.updateOrderItemStatus = async function (itemId, newStatus) {
    const token = getToken();
    if (!token) {
        alert("–ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏");
        return;
    }

    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        const response = await fetch(`${API_BASE}/order-items/${itemId}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify({
                quantity: 1, // ‚Üê –≤—Ä–µ–º–µ–Ω–Ω–æ, –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                priceAtMoment: 0, // ‚Üê –≤—Ä–µ–º–µ–Ω–Ω–æ
                status: newStatus
            })
        });

        if (!response.ok) {
            const error = await response.text().catch(() => "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
            throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å: " + error);
        }

        console.log(`‚úÖ –°—Ç–∞—Ç—É—Å –ø–æ–∑–∏—Ü–∏–∏ ${itemId} –æ–±–Ω–æ–≤–ª—ë–Ω –Ω–∞: ${newStatus}`);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —ç—Ç—É —Å—Ç—Ä–æ–∫—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ), –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤–µ—Å—å —Å–ø–∏—Å–æ–∫
        await loadOrderItems(currentOrderId); // ‚Üê —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:", e);
        alert("–û—à–∏–±–∫–∞: " + e.message);
    }
};
  // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
  window.newOrder = async function () {
    // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const currentUser = await loadCurrentUser();
    if (!currentUser || !currentEmployeeId) return;

    // –û—á–∏—Å—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ (–≤ DOM –∏ –≤ –ø–∞–º—è—Ç–∏)
    orderTempItems = [];
    const listEl = document.getElementById("orderProductList");
    if (listEl) listEl.innerHTML = "";

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —Ç–æ–≤–∞—Ä–æ–≤
    await loadReferenceData();

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—ã
    document.getElementById("orderId").value = "";
    document.getElementById("orderDate").value = new Date()
      .toISOString()
      .split("T")[0];

    // –°–∫—Ä—ã—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –ø–æ–ª–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    const employeeInfo = document.getElementById("currentEmployeeInfo");
    if (employeeInfo) {
      employeeInfo.textContent =
        currentUser.fullName || currentUser.username || "–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
    }

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    const modalTitle = document.getElementById("orderModalTitle");
    if (modalTitle) modalTitle.textContent = "–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑";

    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É
    const modal = new bootstrap.Modal(document.getElementById("orderModal"));
    modal.show();
  };

  window.addProductToOrder = function () {
    console.log("üì• –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä'");

    const select = document.getElementById("orderProductSelect");
    const qtyInput = document.getElementById("orderProductQuantity");

    if (!select || !qtyInput) {
      console.error("‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!");
      alert("–§–æ—Ä–º–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞");
      return;
    }

    const productId = parseInt(select.value);
    const quantity = parseInt(qtyInput.value);

    console.log("–í—ã–±—Ä–∞–Ω–æ: productId =", productId, ", quantity =", quantity);

    if (!productId || isNaN(quantity) || quantity <= 0) {
      alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –∏ —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (> 0)");
      return;
    }

    console.log("–í—Å–µ —Ç–æ–≤–∞—Ä—ã:", allProducts);
    const product = allProducts.find((p) => p.id === productId);
    if (!product) {
      console.error("‚ùå –¢–æ–≤–∞—Ä —Å ID", productId, "–Ω–µ –Ω–∞–π–¥–µ–Ω –≤ allProducts");
      alert("–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
      return;
    }

    const item = {
      productId: product.id,
      productName: product.name,
      quantity: quantity,
      priceAtMoment: Number(product.price),
    };

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤
    orderTempItems.push(item);
    console.log(
      "‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ orderTempItems. –í—Å–µ–≥–æ:",
      orderTempItems.length
    );

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    renderOrderProductList();
calculateOrderTotal(); 
    // –°–±—Ä–æ—Å
    select.value = "";
    qtyInput.value = "1";
  };

  function renderOrderProductList() {
    const list = document.getElementById("orderProductList");
    if (!list) return;

    list.innerHTML = "";
    orderTempItems.forEach((item, idx) => {
      const li = document.createElement("li");
      li.className =
        "list-group-item d-flex justify-content-between align-items-center";
      li.dataset.item = JSON.stringify(item);
      li.innerHTML = `
            ${item.productName} √ó ${item.quantity} –ø–æ ${item.priceAtMoment} ‚ÇΩ
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeProductFromOrder(${idx})">√ó</button>
        `;
      list.appendChild(li);
    });

    console.log(
      "üé® DOM –æ–±–Ω–æ–≤–ª—ë–Ω. –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è",
      orderTempItems.length,
      "—Ç–æ–≤–∞—Ä(–æ–≤)"
    );
  }

  window.removeProductFromOrder = function (index) {
    if (index == null || index < 0 || index >= orderTempItems.length) return;
    orderTempItems.splice(index, 1);
    renderOrderProductList();
    calculateOrderTotal(); 
  };
  window.saveOrder = async function () {
    const date = document.getElementById("orderDate").value;
    const clientId = parseInt(document.getElementById("orderClientId").value);
    const items = orderTempItems.slice();

    if (!date || !clientId || !currentEmployeeId) {
      alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö: –¥–∞—Ç–∞, –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫");
      return;
    }
    if (items.length === 0) {
      alert("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä");
      return;
    }

    const token = getToken();
    const headers = {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token,
    };

    try {
      // === –®–ê–ì 1: –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ ===
      const orderData = {
        date: date,
        clientId: clientId,
        employeeId: currentEmployeeId,
        // –ù–ï–¢ items –∑–¥–µ—Å—å!
      };

      console.log("üì§ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞:", orderData);
      const orderRes = await fetch(API_URL_ORDERS, {
        method: "POST",
        headers,
        body: JSON.stringify(orderData),
      });

      if (!orderRes.ok) {
        const error = await orderRes.text().catch(() => "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
        throw new Error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: " + error);
      }

      const createdOrder = await orderRes.json();
      const orderId = createdOrder.id;
      console.log("‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω —Å ID:", orderId);

      // === –®–ê–ì 2: –°–æ–∑–¥–∞—Ç—å –ø–æ–∑–∏—Ü–∏–∏ ===
      for (const item of items) {
        const orderItemDto = {
          orderId: orderId, // ‚Üê —Ç–µ–ø–µ—Ä—å –∏–∑–≤–µ—Å—Ç–µ–Ω!
          productId: item.productId,
          quantity: item.quantity,
          priceAtMoment: item.priceAtMoment,
          status: "NEW", // ‚Üê –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!
        };

        console.log("üì§ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏:", orderItemDto);
        const itemRes = await fetch(API_BASE + "/order-items", {
          method: "POST",
          headers,
          body: JSON.stringify(orderItemDto),
        });

        if (!itemRes.ok) {
          const error = await itemRes.text().catch(() => "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
          throw new Error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏: " + error);
        }
      }

      console.log("‚úÖ –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");

      // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
      bootstrap.Modal.getInstance(document.getElementById("orderModal")).hide();
      await loadOrders();
    } catch (err) {
      console.error("üí• –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –∏–ª–∏ –ø–æ–∑–∏—Ü–∏–π:", err);
      alert("–û—à–∏–±–∫–∞: " + err.message);
    }
  };

  window.viewOrderItems = async function (orderId) {
    currentOrderId = orderId;
    const modal = new bootstrap.Modal(
      document.getElementById("orderItemsModal")
    );
    modal.show();
    await loadOrderItems(orderId);
  };

window.deleteOrderItem = async function (orderId, itemId) {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é?")) return;

    const token = getToken();
    try {
        // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ ‚Äî –ø–æ –µ—ë ID
        const response = await fetch(`${API_BASE}/order-items/${itemId}`, {
            method: "DELETE",
            headers: { "Authorization": "Bearer " + token }
        });

        if (response.ok) {
            await loadOrderItems(orderId);
        } else {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é");
        }
    } catch (e) {
        console.error(e);
        alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
    }
};

  window.deleteOrder = async function (id) {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å –≤–µ—Å—å –∑–∞–∫–∞–∑?")) return;

    const token = getToken();
    try {
      const response = await fetch(`${API_URL_ORDERS}/${id}`, {
        method: "DELETE",
        headers: { Authorization: "Bearer " + token },
      });

      if (response.ok) {
        await loadOrders();
      } else {
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑");
      }
    } catch (e) {
      console.error(e);
      alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
    }
  };

  window.initOrdersView = async function () {
    // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞—Ç–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –∏ –∑–∞–∫–∞–∑—ã
    await loadCurrentUser();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    const token = getToken();
    const productsRes = await fetch(API_URL_PRODUCTS, {
      headers: { Authorization: "Bearer " + token },
    });
    if (productsRes.ok) {
      allProducts = await productsRes.json();
    }

    // –ó–∞–≥—Ä—É–∑–∏–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (clients/products) –≤–Ω—É—Ç—Ä–∏ loadOrders ‚Äî –Ω–æ –º–æ–∂–Ω–æ –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ
    await loadOrders();
    const searchInput = document.getElementById("searchOrders");
    if (searchInput) {
      searchInput.addEventListener("input", filterOrders);
    }
  };
})();
